<!DOCTYPE html>
<meta charset="UTF-8">
<html>
<head>
<title>Mkt</title>
</head>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="js/funcs.js"></script>
<script src="js/fDate.js"></script>
<link rel="stylesheet" href="style.css" />
<link rel="icon" type="image/x-icon" href="images/chart.ico">

<script>

var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() { // Check if fetch request is done
    if (xhr.readyState == 4 && xhr.status == 200) { 
        jsonData = JSON.parse(xhr.responseText);
        processQ(jsonData);
    }
}

let  resp = 'a';
data = "";

function getQ() {
  now = date_format(new Date(), 'g:i:sa');
  console.log(now);
  prx = "https://api.allorigins.win/raw?url=";
  url = "https://query2.finance.yahoo.com/v7/finance/quote?symbols=^ixic,^DJI,^GSPC,aapl,GOOG,FB,AMZN,hsbc,tsla,MKTX,BTC-USD,ETH-USD,CL=F,GC=F,NQ=F,ES=F,YM=F,^TNX,QQQ,SPY" + ',X' + now
  xhr.open("GET", prx + url, true);
  xhr.send();
}


function processQ(data) {
  let tdHtml = '';tbHtml = '';

  thHtml = '<table class="tblX" id="mytbl"><thead onclick="getQ()"><tr>';
  
  heads = [now,'Last','Chg','Chg%'] // ,'State','Type']
  for (h = 0, len = heads.length; h < len; h++ ) {
    if (h>0){ clsJust = ' class="clsRt"'} else {clsJust = ""};
    console.log(clsJust);
    thHtml += '<th' + clsJust + '>' + heads[h] + '</th>';
  }
  thHtml += '</tr></thead>';

  ticks =  data.quoteResponse.result.length
  for (q = 0, trHtml = ""; q < ticks; q++) {
    rq = data.quoteResponse.result[q];
    row = [rq.shortName.substring(0, 20),rq.regularMarketPrice.toFixed(2),rq.regularMarketChange.toFixed(2),rq.regularMarketChangePercent.toFixed(2)+'%'] // ,rq.marketState,rq.quoteType.substring(0, 6)]
    for (r = 0, trHtml = '', len = row.length; r < len; r++ ) {
      if (r>0){ clsJust = ' class="clsRt"'} else {clsJust = ""};
      if (rq.regularMarketChangePercent > 0) {chgcol = "chggrn";} else {chgcol = "chgred"}
      trHtml += '<td' + clsJust + '>' + row[r] + '</td>';
    }
    tbHtml += '<tr class="' + chgcol + '">' + trHtml + '</tr>';

  }
  
  document.getElementById("app1").innerHTML = thHtml + tbHtml + '</table>';
  document.getElementById("app2").innerHTML = '<a href="' + url + '" target="blank">json<a/>';
  
  
}
  getQ();

</script>

<body>
  <p ></p>
    <!-- <button id="get" onclick="getQ()">GET</button><br><br> -->
    <div style="color:rgb(55, 73, 155) !important" id="app1"></div><br>
    <div id="app2"></div><br>
    <!-- <div id="app3">3</div><br>
    <div id="app4">4</div><br> -->

</body>
</html>
    