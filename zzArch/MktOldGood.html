<!DOCTYPE html>
<meta charset="UTF-8">
<html>
<head>
<title>Mkt</title>
</head>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="js/funcs.js"></script>
<script src="js/fDate.js"></script>
<link rel="stylesheet" href="style.css" />
<link rel="icon" type="image/x-icon" href="images/mkt.ico">

<script>

var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() { // Check if fetch request is done
    if (xhr.readyState == 4 && xhr.status == 200) { 
        jsonData = JSON.parse(xhr.responseText);
        processQ(jsonData);
    }
}

let  resp = 'a';
data = "";

async function getQ() {
  now = date_format(new Date(), 'g:i:sa');
  console.log(now);
  prx = "https://api.allorigins.win/raw?url=";

  vFut = 'YM=F,NQ=F,ES=F,'
  vIdx = '^DJI,^IXIC,^GSPC,'

  url = `https://query2.finance.yahoo.com/v7/finance/quote?symbols=${vIdx},${vFut}KRE,AAPL,GOOG,FB,AMZN,HSBC,TSLA,QQQ,SPY,BTC-USD,ETH-USD,CL=F,GC=F,^TNX` + ',X' + now
  xhr.open("GET", prx + url, true);
  xhr.send();
}

function processQ(data) {
  let tdHtml = '';tbHtml = '';

  thHtml = '<table onclick="getQ()" class="tblX" id="mytbl"><thead><colgroup><col style="width:40%"/><col style="width:15%"/><col style="width:15%" /><col style="width:12%"/></colgroup><tr>';
  
  heads = [now,'Last','Chg','%'] // ,'State','Type']
  for (h = 0, len = heads.length; h < len; h++ ) {
    if (h>0){ clsJust = ' class="clsRt"'} else {clsJust = ""};
    // console.log(clsJust);
    thHtml += '<th' + clsJust + '>' + heads[h] + '</th>';
  }
  thHtml += '</tr></thead>';

  ticks = data.quoteResponse.result.length
  for (q = 0, trHtml = ""; q < ticks; q++) {
    rq = data.quoteResponse.result[q];
  
    desc = ''; subs = '';
    if (rq.symbol=="^DJI" ) {desc = 'Dow';      subs = 'YM=F';  }
    if (rq.symbol=="^IXIC") {desc = 'Nasdaq';   subs = '^TNX';  }
    if (rq.symbol=="^GSPC") {desc = 'S&P 500';  subs = 'FS=F';  }

    if (rq.hasOwnProperty('preMarketPrice')) { preQ = 'pre'; dot = '<span id="stFlag" style="color:var(--colPre); font-size:xx-small; font-weight:bold;margin-left:5px;">PRE</span>'} else { preQ = 'regular'; dot=''}
    
    row = [ (desc || rq.shortName.substring(0, 15)) + dot ,numStd(rq[preQ+'MarketPrice'],0),numStd(rq[preQ+'MarketChange']),numStd(rq[preQ+'MarketChangePercent'],1)+'%'] 
    
    clsSt = mktSt(rq.marketState, preQ)
    console.log(rq.marketState, preQ, clsSt, rq.quoteType, rq.symbol, subs);   

    if (rq.marketState=='PRE' && preQ=='regular') { pctFac = 0} else { pctFac = 1 } //turn off index shading pre-market

    col = chgCol(rq[preQ+'MarketChangePercent'] * pctFac,clsSt);
    
    for (r = 0, trHtml = '', len = row.length; r < len; r++ ) {
      if (r>0){ clsAdd = ' class="' + clsSt + ' clsRt"'} else {clsAdd = ""};
      trHtml += '<td' + clsAdd + '>' + row[r] + '</td>';

    }
  
    tbHtml += '<tr ' + col + '>' + trHtml + '</tr>';

  }
  
  document.getElementById("app1").innerHTML = thHtml + tbHtml + '</table>';
  document.getElementById("app2").innerHTML = '<a href="' + url + '" target="blank">json<a/>';
  
}

getQ();

setInterval(getQ, 5 * 60000);

</script>

<body>
  <p></p>
     <div id="app1"></div><br>
    <div id="app2"></div><br>
    <!-- <div id="app3">3</div><br>
    <div id="app4">4</div><br> -->

</body>
</html>
    