<!DOCTYPE html>
<html>
<head>

<link rel="stylesheet" href="style.css" />
<script src="js/funcs.js"></script>
<script src="js/fDate.js"></script>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/css/bootstrap.min.css" rel="stylesheet">

<link rel="icon" type="image/x-icon" href="images/Sol.ico">

<script>

key = "da5f0d9ce3486ef93fd7ffb24235c9e3"
// key = "a35e66501c88031db5054c862c6e5b15"

var xhr = new XMLHttpRequest();
var xhrz = new XMLHttpRequest();
paramzip = "10025";
var tblhr ="";

// Called whenever the readyState attribute changes 
xhr.onreadystatechange = function() { // Check if fetch request is done
    if (xhr.readyState == 4 && xhr.status == 200) { 
        jsonData = JSON.parse(xhr.responseText);
        getWea(jsonData);
    }
}
xhrz.onreadystatechange = function() { // Check if fetch request is done
    if (xhrz.readyState == 4 && xhrz.status == 200) { 
        jsonZip = JSON.parse(xhrz.responseText);
        getZip(jsonZip);
    }
}

function init() {
    paramzip = gup("zip") || "10025";
    // document.getElementById("tblhr").innerHTML = tblhr;
    console.log("init run"); 
    callzip();
}

function callzip() {
  url = "https://api.openweathermap.org/geo/1.0/zip?zip=" + paramzip + "&appid=" + key
  xhrz.open("GET", url, true);
  xhrz.send();
  }

function getZip(dataz) {
   document.getElementById("zipcd").innerHTML = dataz.name + " (" + dataz.zip + ")";
   document.getElementById("linkddg").href = "https://duckduckgo.com/&ia=weather?q=weather+zip+" + dataz.zip
   lat = dataz.lat
   lon = dataz.lon
   callwea();
}

function callwea() {
  url = "https://api.openweathermap.org/data/2.5/onecall?lat=" + lat + "&lon=" + lon + "&units=imperial&exclude=minutely&appid=" + key;
  document.getElementById('linkjson').href = url
  xhr.open("GET", url, true);
  xhr.send();
}

tblhd= '<table class="table" id="mytbl"><thead><tr>'
      + '<th>Time</th>'
      + '<th>Temp</th>'
      + '<th>Hmd</th>'
      + '<th>Weather</th>'
    +'</tr></thead>';

function getWea(data) {  
  myOffset = date_format(new Date(),'Z');  
  zpOffset  = data.timezone_offset;
  shift = zpOffset - myOffset;
  console.log(shift);

  dateVal = new Date((data.current.dt + shift) *1000);
      dtnow = date_format(dateVal, 'g:i');
      tblhr = ""
      tblhr += "<tr>" 
            + "  <td>" + dtnow + "</td>"
            + '  <td class="hl"><b>' + parseInt(.5 + data.current.temp) + "°</b></td>"
            + "  <td>" + data.current.humidity + "%" + "</td>"
            + "  <td>" + geticon(data.current.weather[0].icon) + data.current.weather[0].description   +"</td>"
            + "</tr>";
    
    let txt = "";
    for (let i = 1; i < 8; i++) {
      var xd = new Date((data.hourly[i].dt+ shift)*1000);
      dthr = date_format(xd, 'g a');
      tblhr += "<tr>" 
            + "  <td>" + dthr + "m</td>"
            + "  <td>" + parseInt(.5 + data.hourly[i].temp) + "°</td>"
            + "  <td>" + data.hourly[i].humidity + "%" + "</td>"
            + "  <td>" + geticon(data.hourly[i].weather[0].icon) + data.hourly[i].weather[0].description + "</td>"
            + "</tr>";
      }
 
      for (let j = 1; j < 7; j++) {
      var xd = new Date((data.daily[j].dt+ shift)*1000);
      dthr = date_format(xd, 'D');

      tblhr += "<tr class='day'>" 
            + "  <td>" + dthr + "</td>"
            + "  <td>" + parseInt(.5 + data.daily[j].temp.max)+ "-" +parseInt(.5 + data.daily[j].temp.min) + "°</td>"
            + "  <td>" + data.daily[j].humidity + "%" + "</td>"
            + "  <td>" + geticon(data.daily[j].weather[0].icon) + data.daily[j].weather[0].description + "</td>"
            + "</tr>";
      }
   tblhr += "</tbody></table>";

   
    if(data.hasOwnProperty('alerts')) { 
      document.getElementById("alerts").innerHTML = data.alerts[0].event; 
      document.getElementById('alerts').style.display = 'inline-block';
      document.getElementById('alerts').href = "https://forecast.weather.gov/MapClick.php?lat=" + lat + "&lon=" + lon;
      console.log("https://forecast.weather.gov/MapClick.php?lat=" + lat + "&lon=" + lon);
      alertwidth = document.getElementById('alerts').offsetWidth
      document.getElementById('alerts').style.left = 'calc(50% - '+ alertwidth +'px /2)';
      console.log('(calc(50% - '+ alertwidth +'px /2)')

    } else {
      alerts = ""
      document.getElementById('alerts').style.display = 'none';
    }


   dateVal = new Date((data.daily[0].sunrise+ shift) *1000);
   srise = date_format(dateVal, 'g:ia');
   dateVal = new Date((data.daily[0].sunset + shift) *1000);
   sset =  date_format(dateVal, 'g:ia');

   dateVal = new Date((data.daily[0].moonrise+ shift) *1000);
   mrise =  date_format(dateVal, 'g:ia');
   dateVal = new Date((data.daily[0].moonset + shift) *1000);
   mset =  date_format(dateVal, 'g:ia');
   
   document.getElementById("tblhr").innerHTML = "";
   document.getElementById("tblhr").innerHTML = tblhd + tblhr;   
   
   document.getElementById("sunbox" ).innerHTML = '<img src="svg/Clear.svg" alt="Sunrise" class="weaicon"/>' + " " + srise  + " - " + sset;
   document.getElementById("moonbox").innerHTML = getmoon(data.daily[0].moon_phase) + " " + mrise  + " - " + mset;
 }
	
 window.onload = init;

function chgzip() {
  paramzip = prompt('Zip Code', paramzip || "10025");
  callzip();
}


function themer () {
    th = document.getElementById("themer").value;
    console.log(th)
    switch (th) {
      case 'dark': val = ['var(--dark-def)','var(--dark-day)','var(--dark-cur)','var(--dark-bkg)','url("images/SkyDark.jpg")']; break;
      case "mint": val = ['var(--mint-def)','var(--mint-day)','var(--mint-cur)','var(--mint-bkg)','url("images/SkyMint.jpg")']; break;
      case "pink": val = ['var(--pink-def)','var(--pink-day)','var(--pink-cur)','var(--pink-bkg)','url("images/SkyPink.jpg")']; break;
      case "bayj": val = ['var(--bayj-def)','var(--bayj-day)','var(--bayj-cur)','var(--bayj-bkg)','url("images/SkyBeige.jpg")']; break;
    }
    document.documentElement.style.setProperty('--live-def',val[0]);
    document.documentElement.style.setProperty('--live-day',val[1]);
    document.documentElement.style.setProperty('--live-cur',val[2]);
    document.documentElement.style.setProperty('--live-bkg',val[3]);  
    document.querySelector(".pop").style.backgroundImage =  val[4];

    document.querySelector(".table").style.borderColor =  getComputedStyle(document.documentElement).getPropertyValue('--live-def') + '50 !imporatant';

    newcol = (getComputedStyle(document.documentElement).getPropertyValue('--live-def') + '50');
    document.documentElement.style.setProperty('--live-bor',newcol);
    document.getElementById("mytbl").style.borderColor = newcol
  
  }


function geticon(iconcd) {
  switch(iconcd) {
    case '01d':                   ico="Clear";break;
    case '01n':                   ico="ClearNt";break;
    case '02d': case '03d': case '04d': ico="Partly";break;
    case '02n': case '03n': case '04n': ico="PartlyNt";break;
    case '09d': case '10d': case '11d': case'50d': ico="Rain";break;
    case '09n': case '10n': case '11n': case'50n': ico="Rain";break;
    case '13d': case '13n':       ico="Snowy";break;
    default:                      ico="?";
  }
  svg = '<img src="svg/' + ico + '.svg" alt="' + ico + '" class="weaicon"/>';
  console.log(iconcd + ' ' + ico);
  return svg
}


const phases =     ["Moon0New", "Moon1WxC", "Moon2WxQ", "Moon3WxG", "Moon4Ful", "Moon5WnG", "Moon6WnQ", "Moon7WnC", "Moon0New"];
const phasesDesc = ["New Moon", "Waxing Crescent", "Waxing Quarter", "Waxing Gibbous", "Full Moon !!", "Waning Gibbous", "Waning Quarter", "Waning Crescent", "New Moon"];
var moonInner = "";

function getmoon(phase) {
  ph = parseInt(8 * (phase + 1/16))
  moon = '<img src="svg/' + phases[ph] + '.svg" alt="Moon" class="weaicon"/>';
  for (let k = 0; k < 8; k++) {
    moonInner += '<br><img src="svg/' + phases[k] + '.svg" alt="Moon" id="phimg' + k + '" style="filter:brightness(70%)" class="weaicon"/><span id="phdesc' + k + '">    ' +  phasesDesc[k] + "</span><br><br>";

  } 
  document.getElementById("pop-moon").innerHTML = moonInner;
  document.getElementById("phdesc" + ph).style.color = 'var(--live-cur)';
  document.getElementById("phimg" + ph).style.filter = "brightness(120%)"; 
  return moon;
}

// MOON PHASES
// daily.moon_phase Moon phase. 0 and 1 are 'new moon', 
// 0.25 is 'first quarter moon', 
// 0.5 is 'full moon' and 0.75 is 'last quarter moon'. 
// The periods in between are called 'waxing crescent', 'waxing gibous', 'waning gibous', and 'waning crescent', respectively. 

</script>

<title>Sol</title>
</head>
<body>

<table style="width:100%">
  <tbody>
  <tr>
    <td><div id="zipcd" onclick="chgzip()"></div></td>
    <td style="text-align: right"><select name="theme" id="themer" class="themedd" onchange="themer()">
      <option value="dark" style="color: rgb(61, 114, 179);">Dark</option>
      <option value="pink" style="color: rgb(170, 24, 151);">Pink</option>
      <option value="mint" style="color: rgb(26, 145, 11);" >Mint</option>
      <option value="bayj" style="color: rgb(148, 100, 27);">Beige</option>
    </select>
  </td>
  </tr>
  </tbody>
</table>

<a id="alerts" class="alerts" href="https://openweathermap.org/city/5128581"></a>

<div id="tblhr"></div>

<table class="riseset">
  <tbody>
  <tr>
  <td id="sunbox" ></td>
  <td id="moonbox" onclick="showpop(7,'pop-moon')"></td>
  </tr>
  </tbody>
</table>
<br>

<div class="pop" id="pop-moon" onclick="document.getElementById('pop-moon').style.display = 'none';"></div>

<!-- <a href="https://vxnj.github.io/x/">main<a/> -->
<a id="linkjson" href="https://api.openweathermap.org/data/2.5/onecall?lat=40.8&lon=-73.97&units=imperial&exclude=minutely&appid=da5f0d9ce3486ef93fd7ffb24235c9e3"
target="blank">json<a/>
<a id="linkddg" href="https://duckduckgo.com/?q=weather+upper+west+side%2C+Ny&t=ffsb&atb=v229-1&ia=weather" target="blank">ddg<a/>
<a href="https://openweathermap.org/city/5128581">openweather<a/>

</body>
</html>